<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGuardian - Environmental Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #F8FAFC;
            color: #0F172A;
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Top Banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .connection-banner.connected {
            background: linear-gradient(135deg, #059669, #047857);
        }

        #data-source { font-size: 0.7rem; opacity: 0.9; }

        /* Header */
        header {
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .logo-section {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #E2E8F0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #059669, #6366F1);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.125rem;
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #059669, #6366F1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #64748B;
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
        }

        /* Sensor Cards */
        .sensors-section {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .sensor-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 0.75rem;
            padding: 1rem;
            position: relative;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #059669, #6366F1);
        }

        .sensor-card.alert::before {
            background: linear-gradient(90deg, #EF4444, #DC2626);
        }

        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .sensor-title {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748B;
        }

        .sensor-icon { font-size: 0.875rem; }

        .sensor-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.65rem;
            font-weight: 600;
            background: #D1FAE5;
            color: #059669;
            border: 1px solid #A7F3D0;
        }

        .sensor-badge.warning {
            background: #FEF3C7;
            color: #F59E0B;
            border-color: #FDE68A;
        }

        .sensor-badge.alert {
            background: #FEE2E2;
            color: #EF4444;
            border-color: #FECACA;
        }

        .sensor-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0F172A;
            margin: 0.5rem 0;
        }

        .sensor-updated {
            font-size: 0.65rem;
            color: #94A3B8;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* Chart */
        .chart-section {
            grid-column: span 12;
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .chart-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0F172A;
        }

        canvas {
            width: 100% !important;
            height: 220px !important;
        }

        /* Controls */
        .controls-section {
            grid-column: span 7;
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0F172A;
            margin-bottom: 0.75rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .control-btn {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-btn:hover {
            border-color: #059669;
            background: white;
        }

        .control-btn.auto-activated {
            background: #FEF3C7;
            border-color: #F59E0B;
        }

        .control-icon-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .control-icon-label i { font-size: 1rem; }

        .control-status {
            padding: 0.2rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.65rem;
            font-weight: 600;
            background: #E2E8F0;
            color: #64748B;
        }

        .control-btn.auto-activated .control-status {
            background: #F59E0B;
            color: white;
        }

        /* Alerts */
        .alerts-section {
            grid-column: span 5;
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .alert-log {
            max-height: 280px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            gap: 0.6rem;
            padding: 0.6rem;
            background: #F8FAFC;
            border-radius: 0.4rem;
            border-left: 3px solid #059669;
            margin-bottom: 0.5rem;
        }

        .alert-item.warning { border-left-color: #F59E0B; }
        .alert-item.danger { border-left-color: #EF4444; }

        .alert-icon {
            width: 24px;
            height: 24px;
            border-radius: 0.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #D1FAE5;
            color: #059669;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .alert-item.warning .alert-icon {
            background: #FEF3C7;
            color: #F59E0B;
        }

        .alert-item.danger .alert-icon {
            background: #FEE2E2;
            color: #EF4444;
        }

        .alert-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #0F172A;
            margin-bottom: 0.1rem;
        }

        .alert-time {
            font-size: 0.65rem;
            color: #94A3B8;
        }

        /* Modal */
        .lab-screen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .lab-screen-modal.show { display: flex; }

        .lab-screen {
            background: white;
            border: 3px solid #EF4444;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            max-width: 500px;
        }

        .lab-screen h2 {
            font-size: 2rem;
            color: #EF4444;
            margin-bottom: 1rem;
        }

        .lab-screen p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .close-screen {
            background: #EF4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: white;
            border: 1px solid #E2E8F0;
            border-left: 4px solid #059669;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .toast.show { display: flex; }
        .toast i { font-size: 1rem; color: #059669; }
        .toast span { font-size: 0.8rem; }

        @media (max-width: 1200px) {
            .controls-section, .alerts-section { grid-column: span 12; }
        }

        @media (max-width: 768px) {
            .sensors-section { grid-template-columns: 1fr; }
            .controls-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="connection-banner" id="connection-status">
    <div class="status-text">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Connecting to Django server...</span>
    </div>
    <span id="data-source">Initializing...</span>
</div>

<div class="container">
    <header>
        <div class="logo-section">
            <div class="logo-icon"><i class="fas fa-leaf"></i></div>
            <div>
                <h1>EcoGuardian</h1>
                <p class="subtitle">Real-Time Environmental Intelligence</p>
            </div>
        </div>
    </header>

    <div class="dashboard-grid">
        <div class="sensors-section">
            <div class="sensor-card" id="temp-card">
                <div class="sensor-header">
                    <span class="sensor-title">
                        <i class="fas fa-thermometer-half sensor-icon"></i>
                        Temperature
                    </span>
                    <span class="sensor-badge" id="temp-status">
                        <i class="fas fa-clock"></i> Waiting
                    </span>
                </div>
                <div class="sensor-value" id="temp">--¬∞C</div>
                <div class="sensor-updated" id="temp-time">
                    <i class="fas fa-clock"></i> Waiting for Arduino...
                </div>
            </div>

            <div class="sensor-card" id="noise-card">
                <div class="sensor-header">
                    <span class="sensor-title">
                        <i class="fas fa-volume-up sensor-icon"></i>
                        Noise Level
                    </span>
                    <span class="sensor-badge" id="noise-status">
                        <i class="fas fa-clock"></i> Waiting
                    </span>
                </div>
                <div class="sensor-value" id="noise">--dB</div>
                <div class="sensor-updated" id="noise-time">
                    <i class="fas fa-clock"></i> Waiting for Arduino...
                </div>
            </div>

            <div class="sensor-card" id="air-card">
                <div class="sensor-header">
                    <span class="sensor-title">
                        <i class="fas fa-wind sensor-icon"></i>
                        Air Quality
                    </span>
                    <span class="sensor-badge" id="air-status">
                        <i class="fas fa-clock"></i> Waiting
                    </span>
                </div>
                <div class="sensor-value" id="air">--AQI</div>
                <div class="sensor-updated" id="air-time">
                    <i class="fas fa-clock"></i> Waiting for Arduino...
                </div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">Temperature Trend</h3>
                <span class="sensor-badge">
                    <i class="fas fa-history"></i> Last 10 readings
                </span>
            </div>
            <canvas id="tempChart"></canvas>
        </div>

        <div class="controls-section">
            <h3 class="section-title">Automated Controls</h3>
            <div class="controls-grid">
                <button class="control-btn" id="ac-btn">
                    <span class="control-icon-label">
                        <i class="fas fa-snowflake"></i> AC System
                    </span>
                    <span class="control-status">OFF</span>
                </button>
                <button class="control-btn" id="ventilation-btn">
                    <span class="control-icon-label">
                        <i class="fas fa-fan"></i> Ventilation
                    </span>
                    <span class="control-status">OFF</span>
                </button>
                <button class="control-btn" id="noise-cancel-btn">
                    <span class="control-icon-label">
                        <i class="fas fa-volume-mute"></i> Noise Alert
                    </span>
                    <span class="control-status">OFF</span>
                </button>
                <button class="control-btn" id="screen-alert-btn">
                    <span class="control-icon-label">
                        <i class="fas fa-tv"></i> Lab Screen
                    </span>
                    <span class="control-status">Ready</span>
                </button>
            </div>
        </div>

        <div class="alerts-section">
            <h3 class="section-title">Activity Log</h3>
            <div class="alert-log" id="alert-log">
                <div class="alert-item">
                    <div class="alert-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="alert-content">
                        <div class="alert-title">System Initialized</div>
                        <div class="alert-time">Waiting for data...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="lab-screen-modal" id="lab-screen-modal">
    <div class="lab-screen">
        <h2>‚ö†Ô∏è NOISE ALERT ‚ö†Ô∏è</h2>
        <p id="noise-message">High noise level detected!</p>
        <p style="font-size: 0.875rem; color: #64748B; margin-bottom: 1.5rem;">
            Please keep noise levels down in the lab
        </p>
        <button class="close-screen" onclick="closeLabScreen()">Acknowledged</button>
    </div>
</div>

<div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toast-message"></span>
</div>

<script>
const DJANGO_API = 'http://127.0.0.1:8000/api/latest/';
const POLL_INTERVAL = 2000;
const TEMP_THRESHOLD = 26;
const NOISE_THRESHOLD = 65;
const AIR_THRESHOLD = 55;

let tempData = [], labels = [], alerts = [], isConnected = false;
let autoControlState = { ac: false, ventilation: false, noiseAlert: false };

const ctx = document.getElementById('tempChart').getContext('2d');
const gradient = ctx.createLinearGradient(0, 0, 0, 220);
gradient.addColorStop(0, 'rgba(5, 150, 105, 0.15)');
gradient.addColorStop(1, 'rgba(5, 150, 105, 0)');

const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Temperature',
            data: tempData,
            borderColor: '#059669',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#FFFFFF',
            pointBorderColor: '#059669',
            pointBorderWidth: 2,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                titleColor: '#0F172A',
                bodyColor: '#64748B',
                borderColor: '#E2E8F0',
                borderWidth: 1,
                padding: 8,
                displayColors: false
            }
        },
        scales: {
            y: { grid: { color: '#F1F5F9' }, ticks: { color: '#64748B', font: { size: 10 } } },
            x: { grid: { display: false }, ticks: { color: '#64748B', font: { size: 9 } } }
        }
    }
});

async function fetchDataFromDjango() {
    try {
        const response = await fetch(DJANGO_API);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        if (!isConnected) {
            updateConnectionStatus(true);
            addAlert('‚úÖ Connected to Django server', 'info');
        }
        
        if (!data.devices || data.devices.length === 0) {
            document.getElementById('data-source').textContent = 'No Arduino data yet';
            return;
        }
        
        const device = data.devices[0];
        document.getElementById('data-source').textContent = `Device: ${device.device_id}`;
        updateDashboardWithRealData(device);
    } catch (error) {
        if (isConnected) {
            updateConnectionStatus(false);
            addAlert('‚ö†Ô∏è Connection lost', 'danger');
        }
    }
}

function updateDashboardWithRealData(device) {
    const temp = parseFloat(device.temperature);
    const noise = parseFloat(device.noise_level);
    const air = parseFloat(device.air_quality);
    const timestamp = new Date(device.timestamp);
    
    document.getElementById('temp').textContent = `${temp.toFixed(1)}¬∞C`;
    document.getElementById('noise').textContent = `${noise.toFixed(0)}dB`;
    document.getElementById('air').textContent = `${air.toFixed(0)}AQI`;
    
    const timeStr = timestamp.toLocaleTimeString();
    document.getElementById('temp-time').innerHTML = `<i class="fas fa-clock"></i> ${timeStr}`;
    document.getElementById('noise-time').innerHTML = `<i class="fas fa-clock"></i> ${timeStr}`;
    document.getElementById('air-time').innerHTML = `<i class="fas fa-clock"></i> ${timeStr}`;
    
    updateStatusBadge('temp', temp, TEMP_THRESHOLD);
    updateStatusBadge('noise', noise, NOISE_THRESHOLD);
    updateStatusBadge('air', air, AIR_THRESHOLD);
    
    labels.push(timeStr);
    tempData.push(temp);
    if (tempData.length > 10) {
        tempData.shift();
        labels.shift();
    }
    chart.update();
    
    checkAndActivateControls(temp, noise, air);
}

function updateStatusBadge(type, value, threshold) {
    const badge = document.getElementById(`${type}-status`);
    const card = document.getElementById(`${type}-card`);
    
    if (value > threshold) {
        badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> HIGH';
        badge.className = 'sensor-badge alert';
        card.classList.add('alert');
    } else if (value > threshold * 0.9) {
        badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Elevated';
        badge.className = 'sensor-badge warning';
        card.classList.remove('alert');
    } else {
        badge.innerHTML = '<i class="fas fa-check-circle"></i> Normal';
        badge.className = 'sensor-badge';
        card.classList.remove('alert');
    }
}

function checkAndActivateControls(temp, noise, air) {
    if (temp > TEMP_THRESHOLD && !autoControlState.ac) {
        activateDevice('AC');
        addAlert(`üå°Ô∏è High temp (${temp.toFixed(1)}¬∞C) - AC activated`, 'warning');
        showToast(`AC activated - ${temp.toFixed(1)}¬∞C`);
    } else if (temp <= TEMP_THRESHOLD - 2 && autoControlState.ac) {
        deactivateDevice('AC');
    }
    
    if (air > AIR_THRESHOLD && !autoControlState.ventilation) {
        activateDevice('FAN');
        addAlert(`üí® Poor air (${air.toFixed(0)} AQI) - Ventilation on`, 'warning');
    } else if (air <= AIR_THRESHOLD - 5 && autoControlState.ventilation) {
        deactivateDevice('FAN');
    }
    
    if (noise > NOISE_THRESHOLD && !autoControlState.noiseAlert) {
        activateDevice('NOISE');
        sendLabScreenAlert(noise);
        addAlert(`üîä HIGH NOISE (${noise.toFixed(0)} dB) - Alert sent`, 'danger');
    } else if (noise <= NOISE_THRESHOLD - 5 && autoControlState.noiseAlert) {
        deactivateDevice('NOISE');
    }
}

function activateDevice(type) {
    const btnMap = { 'AC': 'ac-btn', 'FAN': 'ventilation-btn', 'NOISE': 'noise-cancel-btn' };
    const btn = document.getElementById(btnMap[type]);
    btn.classList.add('auto-activated');
    btn.querySelector('.control-status').textContent = 'AUTO';
    const stateMap = { 'AC': 'ac', 'FAN': 'ventilation', 'NOISE': 'noiseAlert' };
    autoControlState[stateMap[type]] = true;
}

function deactivateDevice(type) {
    const btnMap = { 'AC': 'ac-btn', 'FAN': 'ventilation-btn', 'NOISE': 'noise-cancel-btn' };
    const btn = document.getElementById(btnMap[type]);
    btn.classList.remove('auto-activated');
    btn.querySelector('.control-status').textContent = 'OFF';
    const stateMap = { 'AC': 'ac', 'FAN': 'ventilation', 'NOISE': 'noiseAlert' };
    autoControlState[stateMap[type]] = false;
}

function sendLabScreenAlert(noiseLevel) {
    document.getElementById('noise-message').textContent = `Noise: ${noiseLevel.toFixed(0)} dB (Threshold: ${NOISE_THRESHOLD} dB)`;
    document.getElementById('lab-screen-modal').classList.add('show');
    const btn = document.getElementById('screen-alert-btn');
    btn.classList.add('auto-activated');
    setTimeout(() => btn.classList.remove('auto-activated'), 5000);
}

function closeLabScreen() {
    document.getElementById('lab-screen-modal').classList.remove('show');
}

function updateConnectionStatus(connected) {
    isConnected = connected;
    const banner = document.getElementById('connection-status');
    if (connected) {
        banner.classList.add('connected');
        banner.querySelector('.status-text').innerHTML = '<i class="fas fa-check-circle"></i> <span>Connected to Django ‚Ä¢ Live Data</span>';
    } else {
        banner.classList.remove('connected');
        banner.querySelector('.status-text').innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Connection Lost</span>';
    }
}

function addAlert(message, type = 'info') {
    alerts.unshift({
        message,
        type,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
    });
    if (alerts.length > 8) alerts.pop();
    updateAlertLog();
}

function updateAlertLog() {
    const iconMap = { 'info': 'fa-info-circle', 'warning': 'fa-exclamation-triangle', 'danger': 'fa-exclamation-circle' };
    document.getElementById('alert-log').innerHTML = alerts.map(alert => `
        <div class="alert-item ${alert.type}">
            <div class="alert-icon"><i class="fas ${iconMap[alert.type]}"></i></div>
            <div class="alert-content">
                <div class="alert-title">${alert.message}</div>
                <div class="alert-time">${alert.time}</div>
            </div>
        </div>
    `).join('');
}

function showToast(message) {
    document.getElementById('toast-message').textContent = message;
    document.getElementById('toast').classList.add('show');
    setTimeout(() => document.getElementById('toast').classList.remove('show'), 3000);
}

addAlert('System started - Connecting...', 'info');
fetchDataFromDjango();
setInterval(fetchDataFromDjango, POLL_INTERVAL);
</script>
</body>
</html>